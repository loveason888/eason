<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智存 - 现代会计档案管理系统 (云端版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, updateDoc, deleteDoc, addDoc, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Firebase 配置 (环境自动注入)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'archive-manager-default';

        // 全局状态
        window.archives = [];
        window.currentUser = null;

        // --- 核心逻辑：认证与数据监听 (遵循 RULE 3: 先认证后查询) ---
        const initApp = async () => {
            try {
                // 1. 优先使用系统提供的 Custom Token，否则使用匿名登录
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 2. 监听认证状态变化
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        window.currentUser = user;
                        showToast(`已连接至云端`);
                        
                        // 3. 只有在确认用户已认证后，才启动 Firestore 监听
                        startFirestoreListener();
                    }
                });
            } catch (error) {
                console.error("Firebase 初始化失败:", error);
                showToast("连接云端失败，请检查网络");
            }
        };

        let unsubscribe = null;
        const startFirestoreListener = () => {
            // 如果已有监听器，先取消
            if (unsubscribe) unsubscribe();

            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'archives');
            
            // 遵循 RULE 2: 使用简单查询，在 JS 端进行过滤
            unsubscribe = onSnapshot(collectionRef, (snapshot) => {
                window.archives = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // 渲染界面
                initYearFilters();
                renderTable();
            }, (error) => {
                console.error("Firestore 监听失败:", error);
                // 权限错误通常在这里捕获，如果认证未完成就请求数据
                if (error.code === 'permission-denied') {
                    showToast("权限不足，正在重新连接...");
                }
            });
        };

        // 暴露给全局的数据库操作函数
        window.saveArchiveToCloud = async (data) => {
            if (!window.currentUser) {
                showToast("未登录，无法保存数据");
                return;
            }
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'archives');
            try {
                if (data.id && typeof data.id === 'string' && data.id.length > 5) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'archives', data.id);
                    await setDoc(docRef, data, { merge: true });
                } else {
                    delete data.id;
                    await addDoc(collectionRef, data);
                }
            } catch (e) {
                console.error("保存失败:", e);
                showToast("云端保存失败");
            }
        };

        window.deleteArchiveFromCloud = async (id) => {
            if (!window.currentUser || !id) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'archives', id);
                await deleteDoc(docRef);
            } catch (e) {
                console.error("删除失败:", e);
            }
        };

        window.onload = initApp;
    </script>
    <style>
        :root { --primary: #00f2fe; --secondary: #4facfe; --dark: #0f172a; --accent: #8b5cf6; }
        body { background-color: var(--dark); color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; }
        .neo-gradient { background: linear-gradient(135deg, var(--primary), var(--secondary)); }
        .neo-glow { box-shadow: 0 0 15px rgba(0, 242, 254, 0.3); }
        .input-field { background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); color: white; transition: all 0.3s ease; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(0, 242, 254, 0.2); outline: none; }
        .table-row:hover { background: rgba(255, 255, 255, 0.03); }
        .merged-cell { vertical-align: middle; text-align: center; border-right: 1px solid rgba(255, 255, 255, 0.05); background: rgba(255, 255, 255, 0.02); }
        .scroll-hidden::-webkit-scrollbar { display: none; }
        #clipboard-helper { position: absolute; left: -9999px; top: 0; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <textarea id="clipboard-helper"></textarea>

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tight text-white flex items-center gap-3">
                    <span class="p-2 neo-gradient rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                        </svg>
                    </span>
                    智存 <span class="text-transparent bg-clip-text neo-gradient text-xl font-medium">Cloud Sync</span>
                </h1>
                <p class="text-slate-400 mt-1">云端会计档案管理系统 (实时数据库已就绪)</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="toggleModal('import-modal')" class="bg-slate-800 text-slate-300 border border-slate-700 px-5 py-2.5 rounded-xl font-medium flex items-center gap-2 hover:bg-slate-700 transition-all">
                    批量导入
                </button>
                <button onclick="openEntryModal()" class="neo-gradient neo-glow text-slate-900 px-6 py-2.5 rounded-xl font-bold flex items-center gap-2 hover:scale-105 transition-transform">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    单条录入
                </button>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass-panel p-5">
                <p class="text-slate-400 text-sm">云端总卷数</p>
                <h3 class="text-3xl font-black mt-1 text-white" id="stat-total-volumes">0</h3>
            </div>
            <div class="glass-panel p-5 border-b-4 border-cyan-500 col-span-1 md:col-span-2">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-3 gap-2">
                    <div>
                        <p class="text-slate-400 text-xs">筛选期卷数</p>
                        <h3 class="text-2xl font-black text-white" id="stat-period-volumes">0 <span class="text-xs font-normal text-slate-500 ml-1">卷</span></h3>
                    </div>
                    <div class="flex items-center gap-2 bg-slate-800/50 p-1.5 rounded-lg border border-white/5">
                        <select id="start-year-filter" onchange="renderTable()" class="bg-transparent text-cyan-400 text-[10px] font-bold outline-none cursor-pointer"></select>
                        <span class="text-slate-600 text-[10px]">至</span>
                        <select id="end-year-filter" onchange="renderTable()" class="bg-transparent text-cyan-400 text-[10px] font-bold outline-none cursor-pointer"></select>
                    </div>
                </div>
                <div id="month-stats-container" class="flex gap-2 overflow-x-auto pb-1 pt-1 scroll-hidden border-t border-white/5 mt-1"></div>
            </div>
            <div class="glass-panel p-5 grid grid-cols-2 gap-2">
                <div>
                    <p class="text-slate-400 text-[10px] uppercase">项目数</p>
                    <h3 class="text-2xl font-black text-cyan-400" id="stat-project-count">0</h3>
                </div>
                <div class="border-l border-white/10 pl-3">
                    <p class="text-slate-400 text-[10px] uppercase">账套数</p>
                    <h3 class="text-2xl font-black text-blue-400" id="stat-org-count">0</h3>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="glass-panel overflow-hidden">
            <div class="p-6 border-b border-white/10 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <h2 class="text-lg font-bold text-white whitespace-nowrap">云端档案清单</h2>
                    <div class="relative w-full md:w-64">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        </span>
                        <input type="text" id="search-input" oninput="renderTable()" placeholder="搜索项目名称..." class="w-full bg-white/5 border border-white/10 rounded-full py-1.5 pl-10 pr-4 text-sm focus:outline-none focus:border-cyan-500/50 transition-all text-white">
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyToExcel()" class="text-xs bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 px-4 py-2 rounded-lg hover:bg-emerald-500 hover:text-white transition-all">复制到 Excel</button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-white/5 text-slate-400 text-[10px] uppercase tracking-wider">
                        <tr>
                            <th class="px-6 py-4">项目部名称</th>
                            <th class="px-6 py-4">账套组织机构</th>
                            <th class="px-6 py-4 text-center">二级核算</th>
                            <th class="px-6 py-4 font-bold text-cyan-400">卷数</th>
                            <th class="px-6 py-4 text-center">会计年度/期间</th>
                            <th class="px-6 py-4">完成日期</th>
                            <th class="px-6 py-4">联系人</th>
                            <th class="px-6 py-4">存放位置</th>
                            <th class="px-6 py-4 text-right">操作</th>
                        </tr>
                    </thead>
                    <tbody id="archive-table-body" class="divide-y divide-white/5">
                        <tr><td colspan="9" class="p-10 text-center text-slate-500">正在连接云端数据库...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="archive-modal" class="fixed inset-0 bg-dark/95 backdrop-blur-md z-50 flex items-center justify-center p-4 hidden">
        <div class="glass-panel w-full max-w-2xl overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-white/10 flex justify-between items-center text-white">
                <h3 class="text-xl font-bold" id="modal-title">档案录入</h3>
                <button onclick="toggleModal('archive-modal')" class="text-slate-400 hover:text-white">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="archive-form" class="p-6 grid grid-cols-1 md:grid-cols-2 gap-5 text-white">
                <input type="hidden" name="id" id="modal-id">
                <div class="col-span-full">
                    <label class="block text-xs text-slate-500 mb-1">是否二级核算项目</label>
                    <select name="isSecondary" id="modal-is-secondary" class="w-full input-field p-2.5 rounded-lg text-white bg-slate-900" onchange="toggleFormMode()">
                        <option value="否">否</option>
                        <option value="是">是</option>
                    </select>
                </div>
                <div id="single-inputs" class="col-span-full grid grid-cols-2 gap-5">
                    <div class="col-span-1">
                        <label class="block text-xs text-slate-500 mb-1">项目部名称</label>
                        <input type="text" name="projectName" id="modal-project-name" class="w-full input-field p-2.5 rounded-lg text-white" placeholder="项目全称">
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs text-slate-500 mb-1">账套组织机构</label>
                        <select name="orgName" id="modal-org-name" class="w-full input-field p-2.5 rounded-lg text-white bg-slate-900">
                            <option value="母公司">母公司</option>
                            <option value="子公司">子公司</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label class="block text-xs text-slate-500 mb-1">移交卷数</label>
                        <input type="number" name="volumeCount" id="modal-volume-count" class="w-full input-field p-2.5 rounded-lg">
                    </div>
                </div>
                <div id="secondary-inputs" class="col-span-full hidden grid grid-cols-2 gap-5 border-y border-white/5 py-4 my-2">
                    <div class="col-span-1 space-y-4 border-r border-white/5 pr-4">
                        <h4 class="text-xs font-bold text-blue-400">母公司侧</h4>
                        <input type="text" name="projectNameMu" id="modal-project-mu" class="w-full input-field p-2 rounded-lg text-xs" placeholder="母公司侧名称">
                        <input type="number" name="volumeCountMu" id="modal-volume-mu" class="w-full input-field p-2 rounded-lg text-xs" placeholder="卷数">
                    </div>
                    <div class="col-span-1 space-y-4 pl-4">
                        <h4 class="text-xs font-bold text-cyan-400">子公司侧</h4>
                        <input type="text" name="projectNameZi" id="modal-project-zi" class="w-full input-field p-2 rounded-lg text-xs" placeholder="子公司侧名称">
                        <input type="number" name="volumeCountZi" id="modal-volume-zi" class="w-full input-field p-2 rounded-lg text-xs" placeholder="卷数">
                    </div>
                </div>
                <div class="col-span-1">
                    <label class="block text-xs text-slate-500 mb-1">会计起始年度</label>
                    <input type="text" name="fiscalYearStart" id="modal-fiscal-year-start" required class="w-full input-field p-2.5 rounded-lg" placeholder="2023">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs text-slate-500 mb-1">会计截止年度</label>
                    <input type="text" name="fiscalYearEnd" id="modal-fiscal-year-end" required class="w-full input-field p-2.5 rounded-lg" placeholder="2024">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs text-slate-500 mb-1">完成日期</label>
                    <input type="text" name="completionDate" id="modal-completion-date" required class="w-full input-field p-2.5 rounded-lg" placeholder="YYYY-MM-DD" onblur="validateAndFormatDate(this)">
                </div>
                <div class="col-span-1">
                    <label class="block text-xs text-slate-500 mb-1">联系人</label>
                    <input type="text" name="contactPerson" id="modal-contact" required class="w-full input-field p-2.5 rounded-lg">
                </div>
                <div class="col-span-full">
                    <label class="block text-xs text-slate-500 mb-1">存放位置</label>
                    <input type="text" name="location" id="modal-location" required class="w-full input-field p-2.5 rounded-lg">
                </div>
                <div class="col-span-full pt-4">
                    <button type="submit" class="w-full neo-gradient p-3 rounded-xl text-dark font-bold hover:neo-glow transition-all">保存到云端</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: 批量导入 -->
    <div id="import-modal" class="fixed inset-0 bg-dark/95 backdrop-blur-md z-50 flex items-center justify-center p-4 hidden">
        <div class="glass-panel w-full max-w-2xl overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-white/10 flex justify-between items-center text-white">
                <div><h3 class="text-xl font-bold">批量导入到云端</h3></div>
                <button onclick="toggleModal('import-modal')" class="text-slate-400 hover:text-white"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            <div class="p-6">
                <textarea id="import-area" class="w-full h-64 input-field p-4 rounded-xl font-mono text-sm" placeholder="在此处粘贴 Excel 数据..."></textarea>
                <div class="mt-6 flex gap-3">
                    <button onclick="processImport()" class="flex-1 neo-gradient p-3 rounded-xl text-dark font-bold hover:neo-glow transition-all">开始云端解析</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 right-8 glass-panel p-4 border-l-4 border-cyan-500 transform translate-y-20 opacity-0 transition-all duration-300 z-[60] text-white"><p class="text-sm font-bold" id="toast-msg">已连接</p></div>

    <script>
        // 界面渲染逻辑
        function initYearFilters() {
            const startSelect = document.getElementById('start-year-filter');
            const endSelect = document.getElementById('end-year-filter');
            if (!window.archives.length) return;
            const years = new Set();
            window.archives.forEach(a => {
                const y = a.completionDate?.substring(0, 4);
                if (y && /^\d{4}$/.test(y)) years.add(y);
            });
            const allYears = [...years].sort((a,b) => a - b);
            if (allYears.length === 0) return;
            const options = allYears.map(y => `<option value="${y}">${y}</option>`).join('');
            const oldStart = startSelect.value;
            const oldEnd = endSelect.value;
            startSelect.innerHTML = options;
            endSelect.innerHTML = options;
            startSelect.value = oldStart || allYears[0];
            endSelect.value = oldEnd || allYears[allYears.length - 1];
        }

        function updateDashboard(currentData) {
            const totalVolumes = window.archives.reduce((a, b) => a + parseInt(b.volumeCount || 0), 0);
            document.getElementById('stat-total-volumes').innerText = totalVolumes;
            const periodVolumes = currentData.reduce((a, b) => a + parseInt(b.volumeCount || 0), 0);
            document.getElementById('stat-period-volumes').innerText = periodVolumes;
            
            const projectKeys = new Set();
            currentData.forEach(a => {
                if (a.isSecondary === '是') projectKeys.add(a.groupKey);
                else projectKeys.add('P_' + a.id);
            });
            document.getElementById('stat-project-count').innerText = projectKeys.size;
            document.getElementById('stat-org-count').innerText = currentData.length;

            const monthStats = Array.from({length: 12}, (_, i) => ({ month: i + 1, count: 0 }));
            currentData.forEach(item => {
                const m = parseInt(item.completionDate?.substring(5, 7));
                if (m >= 1 && m <= 12) monthStats[m-1].count += parseInt(item.volumeCount);
            });
            document.getElementById('month-stats-container').innerHTML = monthStats.map(s => `
                <div class="flex-shrink-0 bg-white/5 border border-white/10 rounded-lg p-2 min-w-[50px] text-center">
                    <p class="text-[9px] text-slate-500 uppercase">${s.month}月</p>
                    <p class="text-xs font-bold ${s.count > 0 ? 'text-cyan-400' : 'text-slate-600'}">${s.count}</p>
                </div>
            `).join('');
        }

        function renderTable() {
            const startY = parseInt(document.getElementById('start-year-filter').value) || 0;
            const endY = parseInt(document.getElementById('end-year-filter').value) || 9999;
            const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
            
            let filtered = window.archives.filter(a => {
                const compYear = parseInt(a.completionDate?.substring(0, 4));
                const inRange = compYear >= startY && compYear <= endY;
                const matchesSearch = !searchTerm || a.projectName?.toLowerCase().includes(searchTerm);
                return inRange && matchesSearch;
            });
            
            updateDashboard(filtered);
            const tbody = document.getElementById('archive-table-body');
            tbody.innerHTML = '';
            
            const groups = [];
            filtered.forEach(item => {
                const key = (item.isSecondary === '是') ? (item.groupKey || 'ERR') : ('S_' + item.id);
                let group = groups.find(g => g.key === key);
                if (!group) { group = { key: key, items: [] }; groups.push(group); }
                group.items.push(item);
            });

            groups.reverse().forEach(group => {
                group.items.forEach((item, index) => {
                    const tr = document.createElement('tr');
                    tr.className = "table-row";
                    const fiscalDisplay = item.fiscalYearStart === item.fiscalYearEnd ? item.fiscalYearStart : `${item.fiscalYearStart}-${item.fiscalYearEnd}`;
                    let html = `
                        <td class="px-6 py-4 font-medium text-slate-200 text-sm">${item.projectName}</td>
                        <td class="px-6 py-4"><span class="text-[9px] px-2 py-0.5 rounded border ${item.orgName === '母公司' ? 'border-blue-500/30 text-blue-400' : 'border-cyan-500/30 text-cyan-400'}">${item.orgName}</span></td>
                    `;
                    if (index === 0) {
                        html += `<td class="px-6 py-4 merged-cell font-bold text-xs ${item.isSecondary === '是' ? 'text-cyan-400' : 'text-slate-700'}" rowspan="${group.items.length}">${item.isSecondary === '是' ? '二级核算' : '普通'}</td>`;
                    }
                    html += `
                        <td class="px-6 py-4 text-cyan-400 font-mono font-bold">${item.volumeCount}</td>
                        <td class="px-6 py-4 text-center text-slate-200 text-sm font-bold">${fiscalDisplay}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${item.completionDate}</td>
                        <td class="px-6 py-4 text-slate-400 text-sm">${item.contactPerson}</td>
                        <td class="px-6 py-4 text-slate-400 text-xs">${item.location}</td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="editEntry('${item.id}')" class="text-slate-600 hover:text-cyan-400 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                                <button onclick="deleteEntry('${item.id}')" class="text-slate-700 hover:text-red-500 transition-colors"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                            </div>
                        </td>
                    `;
                    tr.innerHTML = html;
                    tbody.appendChild(tr);
                });
            });
        }

        function parseSmartDate(str) {
            if (!str) return "";
            let s = str.trim().replace(/[\.\/]/g, '-');
            if (/^\d{8}$/.test(s)) return `${s.substring(0,4)}-${s.substring(4,6)}-${s.substring(6,8)}`;
            const parts = s.split('-');
            if (parts.length === 3) {
                let y = parts[0]; if (y.length === 2) y = "20" + y;
                return `${y}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
            }
            return s;
        }
        function validateAndFormatDate(el) { el.value = parseSmartDate(el.value); }
        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }
        function toggleFormMode() { 
            const isSec = document.getElementById('modal-is-secondary').value === '是'; 
            document.getElementById('single-inputs').classList.toggle('hidden', isSec); 
            document.getElementById('secondary-inputs').classList.toggle('hidden', !isSec); 
        }
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            document.getElementById('toast-msg').innerText = msg; 
            t.classList.remove('translate-y-20', 'opacity-0'); 
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); 
        }

        function openEntryModal(id = null) {
            const form = document.getElementById('archive-form');
            form.reset();
            document.getElementById('modal-id').value = id || '';
            document.getElementById('modal-title').innerText = id ? '云端修改' : '云端录入';
            if (id) {
                const item = window.archives.find(a => a.id === id);
                if (item) {
                    document.getElementById('modal-is-secondary').value = item.isSecondary;
                    document.getElementById('modal-fiscal-year-start').value = item.fiscalYearStart;
                    document.getElementById('modal-fiscal-year-end').value = item.fiscalYearEnd || item.fiscalYearStart;
                    document.getElementById('modal-completion-date').value = item.completionDate;
                    document.getElementById('modal-contact').value = item.contactPerson;
                    document.getElementById('modal-location').value = item.location;
                    if (item.isSecondary === '是') {
                        const related = window.archives.filter(a => a.groupKey === item.groupKey);
                        const mu = related.find(a => a.orgName === '母公司');
                        const zi = related.find(a => a.orgName === '子公司');
                        document.getElementById('modal-project-mu').value = mu?.projectName || '';
                        document.getElementById('modal-volume-mu').value = mu?.volumeCount || 0;
                        document.getElementById('modal-project-zi').value = zi?.projectName || '';
                        document.getElementById('modal-volume-zi').value = zi?.volumeCount || 0;
                    } else {
                        document.getElementById('modal-project-name').value = item.projectName;
                        document.getElementById('modal-org-name').value = item.orgName;
                        document.getElementById('modal-volume-count').value = item.volumeCount;
                    }
                }
            }
            toggleFormMode();
            toggleModal('archive-modal');
        }

        function editEntry(id) { openEntryModal(id); }

        document.getElementById('archive-form').onsubmit = async function(e) {
            e.preventDefault();
            const f = new FormData(this);
            const id = f.get('id');
            const isSec = f.get('isSecondary');
            const shared = {
                fiscalYearStart: f.get('fiscalYearStart'),
                fiscalYearEnd: f.get('fiscalYearEnd'),
                completionDate: parseSmartDate(f.get('completionDate')),
                contactPerson: f.get('contactPerson'),
                location: f.get('location'),
                isSecondary: isSec,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (isSec === '是') {
                    const gKey = (id && window.archives.find(a => a.id === id)?.groupKey) || ("G" + Date.now());
                    if (id) {
                        const oldItem = window.archives.find(a => a.id === id);
                        const related = window.archives.filter(a => a.groupKey === oldItem.groupKey);
                        for(let r of related) await window.deleteArchiveFromCloud(r.id);
                    }
                    await window.saveArchiveToCloud({ ...shared, projectName: f.get('projectNameMu'), volumeCount: f.get('volumeCountMu'), orgName: '母公司', groupKey: gKey });
                    await window.saveArchiveToCloud({ ...shared, projectName: f.get('projectNameZi'), volumeCount: f.get('volumeCountZi'), orgName: '子公司', groupKey: gKey });
                } else {
                    if (id) {
                        const oldItem = window.archives.find(a => a.id === id);
                        if (oldItem.isSecondary === '是') {
                            const related = window.archives.filter(a => a.groupKey === oldItem.groupKey);
                            for(let r of related) await window.deleteArchiveFromCloud(r.id);
                        }
                    }
                    await window.saveArchiveToCloud({ ...shared, id: id, projectName: f.get('projectName'), volumeCount: f.get('volumeCount'), orgName: f.get('orgName') });
                }
                toggleModal('archive-modal');
                showToast("云端保存成功");
            } catch (err) {
                showToast("保存失败");
            }
        };

        async function deleteEntry(id) {
            if(!confirm("确定从云端永久删除吗？")) return;
            const item = window.archives.find(a => a.id === id);
            try {
                if(item && item.isSecondary === '是') {
                    const related = window.archives.filter(a => a.groupKey === item.groupKey);
                    for(let r of related) await window.deleteArchiveFromCloud(r.id);
                } else {
                    await window.deleteArchiveFromCloud(id);
                }
                showToast("已从云端移除");
            } catch (err) {
                showToast("删除失败");
            }
        }

        async function processImport() {
            const text = document.getElementById('import-area').value.trim();
            if (!text) return;
            const rows = text.split('\n');
            showToast(`正在导入 ${rows.length} 条数据...`);
            for (let [idx, row] of rows.entries()) {
                const cols = row.split('\t').map(c => c.trim());
                if (cols.length < 5) continue;
                let yearStart = cols[4], yearEnd = cols[4];
                if (cols[4].includes('-')) { const ys = cols[4].split('-'); yearStart = ys[0]; yearEnd = ys[1]; }
                await window.saveArchiveToCloud({
                    projectName: cols[0], orgName: cols[1].includes('母') ? '母公司' : '子公司',
                    isSecondary: cols[2] === '是' ? '是' : '否', volumeCount: parseInt(cols[3]) || 0,
                    fiscalYearStart: yearStart, fiscalYearEnd: yearEnd,
                    completionDate: parseSmartDate(cols[5]), contactPerson: cols[6], location: cols[7]
                });
            }
            toggleModal('import-modal');
            showToast("批量导入云端完成");
        }

        function copyToExcel() {
            const header = "项目部名称\t账套组织机构\t二级核算\t卷数\t会计年度\t完成日期\t联系人\t存放位置\n";
            const helper = document.getElementById('clipboard-helper');
            helper.value = header + window.archives.map(i => {
                const fy = i.fiscalYearStart === i.fiscalYearEnd ? i.fiscalYearStart : `${i.fiscalYearStart}-${i.fiscalYearEnd}`;
                return `${i.projectName}\t${i.orgName}\t${i.isSecondary}\t${i.volumeCount}\t${fy}\t${i.completionDate}\t${i.contactPerson}\t${i.location}`;
            }).join('\n');
            helper.select(); document.execCommand('copy'); showToast("已复制到剪贴板");
        }
    </script>
</body>
</html>
